<!DOCTYPE html>
<html lang="vi" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo Lịch Thi Trực Tuyến</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải thư viện XLSX (SheetJS) để đọc file Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Tải thư viện jsPDF để xuất PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Thư viện html2canvas để chụp DOM thành ảnh (giúp xuất PDF giữ nguyên ký tự Unicode) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Sử dụng font Inter mặc định của Tailwind */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Thêm một số kiểu dáng tùy chỉnh cho màu hồng */
        .hero-overlay {
            background: linear-gradient(0deg, rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.85));
        }
        .form-section {
            background-color: #fffafb; /* Màu hồng rất nhạt */
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-white text-gray-800">

    <!-- HEADER -->
    <header class="sticky top-0 z-50 w-full bg-white/95 backdrop-blur-sm shadow-md">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo và Tên Web -->
                <div class="flex items-center space-x-2">
                    <svg width="40" height="40" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                        <rect width="200" height="200" rx="30" fill="#FFF1F2"/>
                        <rect x="30" y="60" width="50" height="110" rx="10" fill="#F472B6"/>
                        <rect x="90" y="30" width="50" height="140" rx="10" fill="#EC4899"/>
                        <rect x="150" y="80" width="50" height="90" rx="10" fill="#D946EF" transform="translate(350, 250) rotate(180)"/>
                    </svg>
                    <span class="font-bold text-xl text-pink-600">TaoLichThiTrucTuyen</span>
                </div>
                
                <!-- Navigation -->
                <nav class="hidden md:flex md:space-x-8">
                    <a href="#gioi-thieu" class="font-medium text-gray-600 hover:text-pink-600 transition-colors">Giới thiệu</a>
                    <a href="#huong-dan" class="font-medium text-gray-600 hover:text-pink-600 transition-colors">Hướng dẫn</a>
                    <a href="#ve-chung-toi" class="font-medium text-gray-600 hover:text-pink-600 transition-colors">Về chúng tôi</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main>
        <!-- PHẦN GIỚI THIỆU (HERO) -->
        <section id="gioi-thieu" class="relative h-screen flex items-center justify-center pt-16 overflow-hidden">
            <!-- Ảnh nền minh họa - Mới (Dạng lưới 2x2) -->
            <div class="absolute inset-0 w-full h-full grid grid-cols-2 grid-rows-2 opacity-30">
                <!-- Dán link ảnh JSON của bạn vào đây (Screenshot 001048.png) -->
                <img 
                    src="Screenshot 2025-11-14 001048.png" 
                    alt="Hình ảnh minh họa dữ liệu JSON" 
                    class="w-full h-full object-cover"
                    onerror="this.src='https://placehold.co/1000x800/FFF1F2/EC4899?text=JSON+Input&font=inter'"
                >
                <!-- Dán link ảnh Excel (định dạng 1) của bạn vào đây (Screenshot 001417.png) -->
                <img 
                    src="Screenshot 2025-11-14 001417.png" 
                    alt="Hình ảnh minh họa Excel dạng 1 (thời lượng trong ô)" 
                    class="w-full h-full object-cover"
                    onerror="this.src='https://placehold.co/1000x800/FFF1F2/D946EF?text=Excel+Format+1&font=inter'"
                >
                <!-- Dán link ảnh Excel (định dạng 2) của bạn vào đây (Screenshot 001442.png) -->
                <img 
                    src="Screenshot 2025-11-14 001442.png" 
                    alt="Hình ảnh minh họa Excel dạng 2 (tick chọn)" 
                    class="w-full h-full object-cover"
                    onerror="this.src='https://placehold.co/1000x800/FFF1F2/F472B6?text=Excel+Format+2&font=inter'"
                >
                <!-- Dán link ảnh kết quả của bạn vào đây (Screenshot 001738.png) -->
                 <img 
                    src="Screenshot 2025-11-14 001738.png" 
                    alt="Hình ảnh minh họa kết quả lịch thi chi tiết" 
                    class="w-full h-full object-cover"
                    onerror="this.src='https://placehold.co/1000x800/FFF1F2/EC4899?text=Schedule+Output&font=inter'"
                >
            </div>

            <!-- Lớp phủ văn bản -->
            <div class="relative z-10 text-center max-w-3xl mx-auto p-8 bg-white/90 rounded-xl shadow-xl backdrop-blur-sm">
                <h1 class="text-4xl md:text-5xl font-extrabold text-pink-600 mb-6">
                    Xếp Lịch Thi Thông Minh
                </h1>
                <p class="text-lg text-gray-700 mb-4">
                    Chào mừng bạn đến với <span class="font-semibold text-pink-600">TaoLichThiTrucTuyen</span>! Công cụ giúp bạn tự động hóa việc tạo và tối ưu hóa lịch thi một cách nhanh chóng, công bằng và hiệu quả.
                </p>
                <p class="text-lg text-gray-700 mb-8">
                    Chỉ cần cung cấp thông tin về ngày thi, phòng thi, và dữ liệu học sinh, hệ thống sẽ tự động xếp lịch, giải quyết các xung đột và cân bằng số lượng, giúp bạn tiết kiệm thời gian và công sức.
                </p>
                <a href="#tao-lich" class="inline-block bg-pink-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg text-lg hover:bg-pink-700 transition-transform hover:scale-105">
                    Bắt đầu tạo lịch
                </a>
            </div>
        </section>

        <!-- PHẦN HƯỚNG DẪN -->
        <section id="huong-dan" class="py-24 bg-pink-50/50">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-16">
                    <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-4">Hướng Dẫn Sử Dụng Chi Tiết</h2>
                    <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                        Thực hiện theo các bước sau để có ngay lịch thi tối ưu.
                    </p>
                </div>
                
                <div class="space-y-16">

                    <!-- BƯỚC 1: Chuẩn bị dữ liệu đầu vào -->
                    <article class="bg-white p-8 rounded-lg shadow-lg border border-pink-100">
                        <h3 class="text-2xl font-bold text-pink-700 mb-6">1️⃣ Chuẩn bị dữ liệu đầu vào</h3>
                        <p class="text-gray-700 mb-4">Chọn file học sinh (Excel hoặc JSON) theo một trong các định dạng sau:</p>
                        
                        <div class="space-y-6">
                            <!-- Dạng 1 -->
                            <div>
                                <h4 class="font-semibold text-lg text-gray-800">Excel dạng 1:</h4>
                                <p class="text-gray-600 mb-2">Header là tên môn, ô chứa thời lượng môn (phút). Ô trống → học sinh không thi môn đó.</p>
                                <img src="Screenshot 2025-11-14 001417.png" alt="Ảnh minh họa: File Excel dạng 1" class="rounded-md border border-pink-200 w-full object-contain max-h-72" onerror="this.src='https://placehold.co/800x300/FFF1F2/EC4899?text=Excel+Dang+1&font=inter'">
                            </div>
                            <!-- Dạng 2 -->
                            <div>
                                <h4 class="font-semibold text-lg text-gray-800 mt-4">Excel dạng 2:</h4>
                                <p class="text-gray-600 mb-2">Header môn kèm thời lượng (phút), ô tick ✓ → học sinh thi môn đó, ô trống → không thi.</p>
                                <img src="Screenshot 2025-11-14 001442.png" alt="Ảnh minh họa: File Excel dạng 2" class="rounded-md border border-pink-200 w-full object-contain max-h-72" onerror="this.src='https://placehold.co/800x300/FFF1F2/EC4899?text=Excel+Dang+2&font=inter'">
                            </div>
                            <!-- JSON -->
                            <div>
                                <h4 class="font-semibold text-lg text-gray-800 mt-4">JSON:</h4>
                                <p class="text-gray-600 mb-2">Định dạng <code>{ "student_id": 1, "name": "SV1", "subjects": { "Toán": 60, "Lý": 90 } }</code>.</p>
                                <img src="Screenshot 2025-11-14 001048.png" alt="Ảnh minh họa: File JSON mẫu" class="rounded-md border border-pink-200 w-full object-contain max-h-72" onerror="this.src='https://placehold.co/800x300/FFF1F2/EC4899?text=JSON+Mau&font=inter'">
                            </div>
                        </div>

                        <h4 class="font-semibold text-lg text-gray-800 mt-6 mb-2">Kiểm tra ràng buộc dữ liệu:</h4>
                        <p class="text-gray-700 mb-4">Thời lượng của cùng một môn phải <b>giống nhau</b> cho tất cả học sinh. Môn bị bỏ trống hoặc không tích → học sinh không thi môn đó.</p>
                        <img src="Screenshot 2025-11-14 122050.png" alt="Ảnh minh họa: Kiểm tra ràng buộc thời lượng môn" class="rounded-md border border-pink-200 w-full" onerror="this.src='https://placehold.co/800x200/FFF1F2/EC4899?text=Data+Constraint+Check&font=inter'">
                    </article>

                    <!-- BƯỚC 2: Thiết lập thông tin lịch thi -->
                    <article class="bg-white p-8 rounded-lg shadow-lg border border-pink-100">
                        <h3 class="text-2xl font-bold text-pink-700 mb-6">2️⃣ Thiết lập thông tin lịch thi</h3>
                        <p class="text-gray-700 mb-6">Điền đầy đủ các thông tin chung tại khu vực tạo lịch. Các trường sẽ tuần tự hiện ra:</p>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="border border-pink-100 p-3 rounded-lg bg-pink-50/50">
                                <p class="font-medium text-gray-800 text-center">Chọn ngày bắt đầu/kết thúc</p>
                                <img src="image1.png" alt="Ảnh minh họa: Chọn ngày" class="rounded-md mt-2 w-full" onerror="this.src='https://placehold.co/400x200/FFF1F2/EC4899?text=Select+Dates&font=inter'">
                            </div>
                            <div class="border border-pink-100 p-3 rounded-lg bg-pink-50/50">
                                <p class="font-medium text-gray-800 text-center">Chọn giờ ca sáng/chiều</p>
                                <img src="image2.png" alt="Ảnh minh họa: Chọn giờ ca" class="rounded-md mt-2 w-full" onerror="this.src='https://placehold.co/400x200/FFF1F2/EC4899?text=Select+Time+Slots&font=inter'">
                            </div>
                            <div class="border border-pink-100 p-3 rounded-lg bg-pink-50/50">
                                <p class="font-medium text-gray-800 text-center">Thời gian nghỉ (phút)</p>
                                <img src="image3.png" alt="Ảnh minh họa: Nghỉ giữa môn" class="rounded-md mt-2 w-full" onerror="this.src='https://placehold.co/400x200/FFF1F2/EC4899?text=Break+Time&font=inter'">
                            </div>
                            <div class="border border-pink-100 p-3 rounded-lg bg-pink-50/50">
                                <p class="font-medium text-gray-800 text-center">Nhập số phòng</p>
                                <img src="image4.png" alt="Ảnh minh họa: Nhập số phòng" class="rounded-md mt-2 w-full" onerror="this.src='https://placehold.co/400x200/FFF1F2/EC4899?text=Room+Number&font=inter'">
                            </div>
                            <div class="border border-pink-100 p-3 rounded-lg bg-pink-50/50">
                                <p class="font-medium text-gray-800 text-center">Đặt tên các phòng</p>
                                <img src="image4.png" alt="Ảnh minh họa: Tên phòng" class="rounded-md mt-2 w-full" onerror="this.src='https://placehold.co/400x200/FFF1F2/EC4899?text=Room+Names&font=inter'">
                            </div>
                            <div class="border border-pink-100 p-3 rounded-lg bg-pink-50/50">
                                <p class="font-medium text-gray-800 text-center">Tùy chọn Min/Max số học sinh/phòng</p>
                                <img src="image5.png" alt="Ảnh minh họa: Min/Max" class="rounded-md mt-2 w-full" onerror="this.src='https://placehold.co/400x200/FFF1F2/EC4899?text=Constraints&font=inter'">
                            </div>
                        </div>
                    </article>
                    
                    <!-- BƯỚC 3: Upload dữ liệu và sinh lịch -->
                    <article class="bg-white p-8 rounded-lg shadow-lg border border-pink-100">
                        <h3 class="text-2xl font-bold text-pink-700 mb-6">3️⃣ Upload dữ liệu và sinh lịch</h3>
                        <p class="text-gray-700 mb-4">Sau khi điền đủ thông tin và tải file lên, nhấn nút <b>"Tạo Lịch"</b>.</p>
                         <img src="image6.png" alt="Ảnh minh họa: Nút Tạo Lịch" class="rounded-md border border-pink-200 w-full mb-4" onerror="this.src='https://placehold.co/800x200/FFF1F2/EC4899?text=Create+Schedule+Button&font=inter'">
                        <p class="text-gray-700 mb-4">Web sẽ đọc file (đã chọn) và:</p>
                        <ul class="list-disc list-inside space-y-2 mb-4 text-gray-700">
                            <li>Kiểm tra ràng buộc thời lượng môn.</li>
                            <li>Sinh slot thi theo ca, thời lượng, và nghỉ giữa môn.</li>
                            <li>Phân phòng và cân bằng số học sinh.</li>
                        </ul>
                        <p class="text-gray-700 mb-4">Nếu dữ liệu không hợp lệ (thời lượng khác nhau, file sai định dạng,…) → web sẽ báo lỗi (alert) và yêu cầu chỉnh sửa.</p>
                        <img src="image7.png" alt="Ảnh minh họa: Thông báo lỗi dữ liệu" class="rounded-md border border-pink-200 w-full" onerror="this.src='https://placehold.co/800x200/FFF1F2/EC4899?text=Data+Error+Alert&font=inter'">
                    </article>

                    <!-- BƯỚC 4: Xem và xuất lịch thi -->
                    <article class="bg-white p-8 rounded-lg shadow-lg border border-pink-100">
                        <h3 class="text-2xl font-bold text-pink-700 mb-6">4️⃣ Xem và xuất lịch thi</h3>
                        <p class="text-gray-700 mb-4">Lịch thi sẽ hiển thị ở dạng bảng chi tiết:</p>
                        <p class="font-medium text-gray-800">Học sinh, Mã SV, Môn thi, Thời lượng, Ngày thi, Ca thi, Giờ bắt đầu, Giờ kết thúc, Phòng thi.</p>
                        <img src="image8.png" alt="Ảnh minh họa: Bảng lịch thi chi tiết" class="rounded-md border border-pink-200 w-full mt-4 max-h-96 object-contain" onerror="this.src='https://placehold.co/800x400/FFF1F2/EC4899?text=Bang+Ket+Qua&font=inter'">
                        <p class="text-gray-700 mt-6 mb-4">Bạn có thể xuất PDF để in dán hoặc xuất Excel để chỉnh sửa, gửi email.</p>
                        <img src="image9.png" alt="Ảnh minh họa: Nút xuất PDF/Excel" class="rounded-md border border-pink-200 w-full" onerror="this.src='https://placehold.co/800x150/FFF1F2/EC4899?text=Export+Buttons&font=inter'">
                    </article>

                    <!-- BƯỚC 5: Lưu ý -->
                    <article class="bg-white p-8 rounded-lg shadow-lg border border-pink-100">
                        <h3 class="text-2xl font-bold text-pink-700 mb-6">5️⃣ Lưu ý</h3>
                        <ul class="list-disc list-inside space-y-2 mb-4 text-gray-700">
                            <li>Mỗi môn chỉ thi 1 lần trong ca → tránh trùng môn.</li>
                            <li>Hệ thống cân bằng phòng dựa trên số lượng học sinh.</li>
                            <li>Khoảng nghỉ giữa môn sẽ được tính khi xếp slot.</li>
                            <li>Nếu muốn thay đổi lịch, bạn có thể thay đổi thông tin ca, ngày, phòng rồi upload lại file (hoặc nhấn "Tạo Lịch" lại nếu file không đổi).</li>
                            <li>Nếu không tạo được lịch hãy xem lại số phòng hoặc min/max số học sinh trong một phòng, vì nó có thể không khớp hoặc xung đột</li>
                        </ul>
                        <img src="image.png" alt="Ảnh minh họa: Chỉnh sửa thông tin ca/phòng" class="rounded-md border border-pink-200 mt-4 w-full" onerror="this.src='https://placehold.co/800x200/FFF1F2/EC4899?text=Edit+Config&font=inter'">
                    </article>
                </div>

            </div>
        </section>

        <!-- PHẦN TẠO LỊCH (FORM) -->
        <section id="tao-lich" class="py-24 form-section">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-16">
                    <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-4">Bắt Đầu Cấu Hình Lịch Thi</h2>
                </div>

                <form id="schedule-form" class="bg-white p-8 md:p-12 rounded-xl shadow-2xl border border-pink-200 space-y-10">

                    <!-- 1. Thông tin chung -->
                    <fieldset>
                        <legend class="text-2xl font-bold text-pink-600 mb-6 border-b-2 border-pink-200 pb-2">1. Thông tin chung</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="start_date" class="block text-sm font-medium text-gray-700 mb-1">Ngày bắt đầu</label>
                                <input type="date" id="start_date" name="start_date" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required>
                            </div>
                            <div>
                                <label for="end_date" class="block text-sm font-medium text-gray-700 mb-1">Ngày kết thúc</label>
                                <input type="date" id="end_date" name="end_date" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required>
                            </div>
                        </div>

                        <!-- NEW: Rest days container -->
                        <div id="rest-days-container" class="hidden mt-6 space-y-4 transition-all duration-500">
                            <label class="block text-sm font-medium text-gray-700">Chọn ngày nghỉ (mặc định T7, CN được chọn)</label>
                            <div id="rest-days-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-6 gap-y-2">
                                <!-- Checkboxes will be inserted here by JS -->
                            </div>
                        </div>
                        
                        <!-- Thời gian ca thi (ẩn ban đầu) -->
                        <div id="time-slots-container" class="hidden mt-6 space-y-6 transition-all duration-500">
                            <div>
                                <label for="session_mode" class="block text-sm font-medium text-gray-700 mb-1">Chế độ ca thi</label>
                                <select id="session_mode" name="session_mode" class="w-full md:w-1/2 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500">
                                    <option value="both">Sáng và Chiều</option>
                                    <option value="morning">Chỉ Sáng</option>
                                    <option value="afternoon">Chỉ Chiều</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Chọn ca được phép để xếp môn: cả hai, chỉ sáng, hoặc chỉ chiều.</p>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div id="morning-shift-inputs" class="p-4 border rounded-lg bg-pink-50/50 border-pink-200">
                                    <h4 class="font-semibold text-gray-800 mb-2">Ca Sáng</h4>
                                    <div class="flex space-x-2">
                                        <div>
                                            <label for="start_time_morning" class="block text-xs font-medium text-gray-700">Bắt đầu</label>
                                            <input type="time" id="start_time_morning" name="start_time_morning" value="07:00" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required>
                                        </div>
                                        <div>
                                            <label for="end_time_morning" class="block text-xs font-medium text-gray-700">Kết thúc</label>
                                            <input type="time" id="end_time_morning" name="end_time_morning" value="11:30" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required>
                                        </div>
                                    </div>
                                </div>
                                <div id="afternoon-shift-inputs" class="p-4 border rounded-lg bg-pink-50/50 border-pink-200">
                                    <h4 class="font-semibold text-gray-800 mb-2">Ca Chiều</h4>
                                    <div class="flex space-x-2">
                                        <div>
                                            <label for="start_time_afternoon" class="block text-xs font-medium text-gray-700">Bắt đầu</label>
                                            <input type="time" id="start_time_afternoon" name="start_time_afternoon" value="13:30" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required>
                                        </div>
                                        <div>
                                            <label for="end_time_afternoon" class="block text-xs font-medium text-gray-700">Kết thúc</label>
                                            <input type="time" id="end_time_afternoon" name="end_time_afternoon" value="17:00" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                             <div>
                                <label for="break_minutes" class="block text-sm font-medium text-gray-700 mb-1">Thời gian nghỉ giữa các môn (phút)</label>
                                <input type="number" id="break_minutes" name="break_minutes" value="10" min="0" class="w-full md:w-1/2 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required>
                            </div>
                        </div>
                    </fieldset>

                    <!-- 2. Phòng thi -->
                    <fieldset>
                        <legend class="text-2xl font-bold text-pink-600 mb-6 border-b-2 border-pink-200 pb-2">2. Phòng thi</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                            <div>
                                <label for="num_rooms" class="block text-sm font-medium text-gray-700 mb-1">Số lượng phòng</label>
                                <input type="number" id="num_rooms" name="num_rooms" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ràng buộc số học sinh (tùy chọn)</label>
                                <div class="flex space-x-2">
                                    <input type="number" id="min_students" name="min_students" placeholder="Tối thiểu (Min)" min="1" class="w-1/2 md:w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500">
                                    <input type="number" id="max_students" name="max_students" placeholder="Tối đa (Max)" min="1" class="w-1/2 md:w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500">
                                </div>
                                <p class="text-xs text-gray-500">Nếu bỏ trống, web sẽ tự động chia đều.</p>
                            </div>
                        </div>
                        
                        <!-- Tên phòng (ẩn ban đầu) -->
                        <div id="room-names-container" class="mt-6 hidden transition-all duration-500">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nhập tên các phòng</label>
                            <div id="room-names-inputs" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <!-- JS sẽ chèn input vào đây -->
                            </div>
                        </div>
                    </fieldset>

                    <!-- 3. Dữ liệu -->
                    <fieldset>
                        <legend class="text-2xl font-bold text-pink-600 mb-6 border-b-2 border-pink-200 pb-2">3. Dữ liệu học sinh & môn thi</legend>
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                            <p class="text-sm text-gray-600">
                                Tải lên tệp Excel (<code>.xlsx</code>) hoặc JSON (<code>.json</code>). Vui lòng xem phần Hướng Dẫn để biết định dạng.
                            </p>
                            <button type="button" id="download-template-btn" class="flex-shrink-0 text-sm bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors">
                                Tải file mẫu
                            </button>
                        </div>
                        
                        <div class="flex items-center justify-center w-full">
                            <label for="data_file" class="flex flex-col items-center justify-center w-full h-32 border-2 border-pink-300 border-dashed rounded-lg cursor-pointer bg-pink-50 hover:bg-pink-100 transition-colors">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-10 h-10 mb-3 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V16a4 4 0 01-4 4H7z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 16v-4a2 2 0 012-2h2a2 2 0 012 2v4"></path></svg>
                                    <p class="mb-2 text-sm text-gray-600"><span class="font-semibold">Nhấn để tải lên</span> hoặc kéo thả</p>
                                    <p class="text-xs text-gray-500">JSON hoặc Excel (XLSX)</p>
                                </div>
                                <input id="data_file" type="file" class="hidden" accept=".xlsx, .json">
                            </label>
                        </div>
                        <p id="file-upload-status" class="text-center mt-2 text-sm text-gray-500"></p>
                    </fieldset>
                    
                    <!-- Nút Tạo Lịch -->
                    <div class="text-center pt-6">
                        <button type="button" id="create-schedule-btn" class="w-full md:w-1/2 bg-pink-600 text-white font-bold py-4 px-8 rounded-lg shadow-lg text-lg hover:bg-pink-700 transition-transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                            Tạo Lịch
                        </button>
                        <p id="loading-status" class="mt-4 text-pink-600 hidden">
                            <svg class="animate-spin inline-block h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Đang xử lý, vui lòng chờ...
                        </p>
                    </div>

                </form>
            </div>
        </section>
        
        <!-- PHẦN KẾT QUẢ (ẩn ban đầu) -->
        <section id="ket-qua" class="py-24 bg-white hidden">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-16">
                    <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-4">Lịch Thi Đã Được Tạo</h2>
                    <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                        Đây là kết quả lịch thi ban đầu. Bạn có thể tối ưu hoặc xuất file.
                    </p>
                </div>

                <!-- Khu vực hiển thị lịch thi (placeholder) -->
                <div id="schedule-output" class="bg-gray-50 border border-pink-200 rounded-lg shadow-inner p-6 min-h-[300px] mb-12">
                    <p class="text-gray-500 text-center" id="schedule-placeholder">Lịch thi chi tiết sẽ được hiển thị ở đây...</p>
                    <!-- Bảng lịch thi sẽ được chèn vào đây bằng JS -->
                    <div class="overflow-x-auto relative shadow-md sm:rounded-lg mt-6 hidden" id="schedule-table-container">
                        <table id="schedule-table" class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-pink-100 cursor-pointer">
                                <!-- Header sẽ được tạo bằng JS -->
                            </thead>
                            <tbody class="bg-white">
                                <!-- Dữ liệu sẽ được tạo bằng JS -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Phân trang -->
                    <div id="pagination-controls" class="flex justify-between items-center mt-6 hidden">
                        <button id="prev-page-btn" class="bg-pink-500 text-white py-2 px-4 rounded-lg hover:bg-pink-600 disabled:opacity-50">
                            &larr; Trang trước
                        </button>
                        <span id="page-info" class="text-sm font-medium text-gray-700"></span>
                        <button id="next-page-btn" class="bg-pink-500 text-white py-2 px-4 rounded-lg hover:bg-pink-600 disabled:opacity-50">
                            Trang sau &rarr;
                        </button>
                    </div>
                </div>

                <!-- Nút Tạo lại và Xuất File -->
                <div class="flex flex-col md:flex-row justify-center items-center gap-6">
                    <button type="button" id="regenerate-schedule-btn" class="w-full md:w-auto bg-pink-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-pink-800 transition-all text-base">
                        Tạo lại
                    </button>
                    <button type="button" id="export-pdf-btn" class="w-full md:w-auto bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-red-700 transition-all text-base">
                        Xuất File PDF
                    </button>
                    <button type="button" id="export-excel-btn" class="w-full md:w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-all text-base">
                        Xuất File Excel
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- FOOTER -->
    <footer id="ve-chung-toi" class="bg-gray-900 text-white">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center md:text-left">
                <div>
                    <h3 class="font-bold text-lg text-pink-400 mb-2">TaoLichThiTrucTuyen</h3>
                    <p class="text-gray-400">
                        Giải pháp xếp lịch thi tự động, thông minh, và tiết kiệm thời gian.
                    </p>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-pink-400 mb-2">Liên kết nhanh</h3>
                    <ul class="space-y-1">
                        <li><a href="#gioi-thieu" class="text-gray-400 hover:text-white transition-colors">Giới thiệu</a></li>
                        <li><a href="#huong-dan" class="text-gray-400 hover:text-white transition-colors">Hướng dẫn</a></li>
                        <li><a href="#tao-lich" class="text-gray-400 hover:text-white transition-colors">Tạo lịch</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-pink-400 mb-2">Liên hệ</h3>
                    <p class="text-gray-400">Email: support@taolichthi.vn</p>
                    <p class="text-gray-400">Điện thoại: (028) 6666 6666</p>
                    <p class="text-gray-400">Địa chỉ: 123 Đường ABC, Nam Từ Liêm, Hà Nội</p>
                </div>
            </div>
            <div class="mt-8 pt-8 border-t border-gray-700 text-center text-gray-500">
                &copy; 2025 TaoLichThiTrucTuyen. Mọi quyền được bảo lưu.
            </div>
        </div>
    </footer>

    <!-- JAVASCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // === DỮ LIỆU MẪU VÀ LOGIC XẾP LỊCH (PLACEHOLDER) ===
            // Biến toàn cục để lưu trữ dữ liệu
            let studentData = [];
            let scheduleConfig = {};
            let generatedSchedule = []; // Lịch thi đã tạo (dạng tổng hợp)
            
            // Biến toàn cục cho bảng và phân trang
            let detailedScheduleData = []; // Lịch thi chi tiết (dạng đầy đủ)
            let currentPage = 1;
            const rowsPerPage = 20;
            let sortConfig = { key: 'studentName', direction: 'asc' };

            // === 1. LOGIC CUỘN MƯỢT (SCROLL) ===
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });

            // === 2. LOGIC HIỂN THỊ CÁC TRƯỜNG NHẬP LIỆU CÓ ĐIỀU KIỆN ===

            // Hiển thị chọn thời gian khi đã chọn ngày
            const startDate = document.getElementById('start_date');
            const endDate = document.getElementById('end_date');
            const timeSlotsContainer = document.getElementById('time-slots-container');
            const restDaysContainer = document.getElementById('rest-days-container');
            const restDaysCheckboxes = document.getElementById('rest-days-checkboxes');

            function checkDates() {
                // Clear previous checkboxes
                restDaysCheckboxes.innerHTML = '';

                if (startDate.value && endDate.value) {
                    // Manually parse date strings to avoid timezone issues.
                    // new Date('2025-11-14') can be interpreted as UTC midnight, which might be the previous day in some timezones.
                    const startParts = startDate.value.split('-');
                    const endParts = endDate.value.split('-');
                    
                    // new Date(year, monthIndex, day) is reliably local time.
                    const start = new Date(startParts[0], startParts[1] - 1, startParts[2]);
                    const end = new Date(endParts[0], endParts[1] - 1, endParts[2]);

                    if (start > end) {
                        alert("Ngày kết thúc phải sau ngày bắt đầu.");
                        endDate.value = '';
                        timeSlotsContainer.classList.add('hidden');
                        restDaysContainer.classList.add('hidden');
                        return;
                    }
                    
                    // Generate rest day checkboxes
                    const dayNames = ['Chủ Nhật', 'Thứ Hai', 'Thứ Ba', 'Thứ Tư', 'Thứ Năm', 'Thứ Sáu', 'Thứ Bảy'];
                    let currentDate = new Date(start);

                    while (currentDate <= end) {
                        // Format date to YYYY-MM-DD string reliably, without using toISOString() which can have timezone shifts.
                        const year = currentDate.getFullYear();
                        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                        const day = String(currentDate.getDate()).padStart(2, '0');
                        const dateString = `${year}-${month}-${day}`;

                        const dayName = dayNames[currentDate.getDay()];
                        
                        const checkboxId = `rest-day-${dateString}`;
                        const label = document.createElement('label');
                        label.htmlFor = checkboxId;
                        label.className = "flex items-center space-x-2 text-sm text-gray-700 cursor-pointer";
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = checkboxId;
                        checkbox.name = 'rest_days';
                        checkbox.value = dateString;
                        checkbox.className = "h-4 w-4 rounded border-gray-300 text-pink-600 focus:ring-pink-500";

                        // Automatically check Saturday and Sunday
                        if (currentDate.getDay() === 0 || currentDate.getDay() === 6) {
                            checkbox.checked = true;
                        }

                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(` ${dayName}, ${dateString}`));
                        
                        restDaysCheckboxes.appendChild(label);
                        
                        currentDate.setDate(currentDate.getDate() + 1);
                    }


                    timeSlotsContainer.classList.remove('hidden');
                    restDaysContainer.classList.remove('hidden');
                    // Force repaint to get correct scrollHeight for transition
                    // Use a small timeout to ensure the DOM is updated before calculating scrollHeight
                    setTimeout(() => {
                        timeSlotsContainer.style.maxHeight = timeSlotsContainer.scrollHeight + "px";
                        restDaysContainer.style.maxHeight = restDaysContainer.scrollHeight + "px";
                    }, 10);


                } else {
                    timeSlotsContainer.classList.add('hidden');
                    restDaysContainer.classList.add('hidden');
                    timeSlotsContainer.style.maxHeight = '0px';
                    restDaysContainer.style.maxHeight = '0px';
                }
            }
            startDate.addEventListener('change', checkDates);
            endDate.addEventListener('change', checkDates);

            // Hiển thị/ẩn ca thi dựa trên lựa chọn
            const sessionModeSelect = document.getElementById('session_mode');
            const morningShiftInputs = document.getElementById('morning-shift-inputs');
            const afternoonShiftInputs = document.getElementById('afternoon-shift-inputs');
            const morningTimeInputs = morningShiftInputs.querySelectorAll('input[type="time"]');
            const afternoonTimeInputs = afternoonShiftInputs.querySelectorAll('input[type="time"]');

            function toggleShiftInputs() {
                const selectedMode = sessionModeSelect.value;

                if (selectedMode === 'morning') {
                    morningShiftInputs.classList.remove('hidden');
                    afternoonShiftInputs.classList.add('hidden');
                    morningTimeInputs.forEach(input => input.required = true);
                    afternoonTimeInputs.forEach(input => input.required = false);
                } else if (selectedMode === 'afternoon') {
                    morningShiftInputs.classList.add('hidden');
                    afternoonShiftInputs.classList.remove('hidden');
                    morningTimeInputs.forEach(input => input.required = false);
                    afternoonTimeInputs.forEach(input => input.required = true);
                } else { // 'both'
                    morningShiftInputs.classList.remove('hidden');
                    afternoonShiftInputs.classList.remove('hidden');
                    morningTimeInputs.forEach(input => input.required = true);
                    afternoonTimeInputs.forEach(input => input.required = true);
                }
            }

            sessionModeSelect.addEventListener('change', toggleShiftInputs);
            // Gọi lần đầu để khởi tạo
            toggleShiftInputs();

            // Hiển thị ô nhập tên phòng dựa trên số lượng phòng
            const numRoomsInput = document.getElementById('num_rooms');
            const roomNamesContainer = document.getElementById('room-names-container');
            const roomNamesInputs = document.getElementById('room-names-inputs');

            numRoomsInput.addEventListener('input', (e) => {
                const num = parseInt(e.target.value, 10);
                roomNamesInputs.innerHTML = ''; // Xóa input cũ

                if (num > 0) {
                    roomNamesContainer.classList.remove('hidden');
                    for (let i = 1; i <= num; i++) {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.placeholder = `Tên phòng ${i}`;
                        input.className = 'w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500';
                        input.name = `room_name_${i}`;
                        roomNamesInputs.appendChild(input);
                    }
                } else {
                    roomNamesContainer.classList.add('hidden');
                }
            });

            // Ràng buộc logic cho Min/Max students
            const minStudentsInput = document.getElementById('min_students');
            const maxStudentsInput = document.getElementById('max_students');

            minStudentsInput.addEventListener('input', () => {
                const minVal = parseInt(minStudentsInput.value, 10);
                if (!isNaN(minVal) && minVal > 0) {
                    maxStudentsInput.min = minVal;
                    const maxVal = parseInt(maxStudentsInput.value, 10);
                    // If max is already entered and is now less than the new min, clear max
                    if (!isNaN(maxVal) && maxVal < minVal) {
                        maxStudentsInput.value = '';
                    }
                }
            });
            
            maxStudentsInput.addEventListener('input', () => {
                const maxVal = parseInt(maxStudentsInput.value, 10);
                const minVal = parseInt(minStudentsInput.value, 10);
                if (!isNaN(maxVal) && !isNaN(minVal) && maxVal < minVal) {
                    // This state should be hard to reach if .min attribute is set correctly, but as a fallback.
                    maxStudentsInput.setCustomValidity(`Giá trị tối đa không được nhỏ hơn giá trị tối thiểu (${minVal}).`);
                    maxStudentsInput.reportValidity();
                } else {
                    maxStudentsInput.setCustomValidity('');
                }
            });

            // === 3. LOGIC XỬ LÝ FILE UPLOAD ===
            const dataFileInput = document.getElementById('data_file');
            const fileStatus = document.getElementById('file-upload-status');

            dataFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    studentData = []; // Xóa dữ liệu cũ khi chọn file mới
                    
                    fileStatus.textContent = `Đã chọn tệp: ${file.name}`;
                    fileStatus.classList.add('text-green-600');
                    fileStatus.classList.remove('text-red-600');
                    
                    const reader = new FileReader();
                    
                    if (file.name.endsWith('.json')) {
                        reader.onload = (event) => {
                            try {
                                studentData = JSON.parse(event.target.result);
                                console.log("JSON Data:", studentData);
                                alert("Đã tải và phân tích tệp JSON thành công!");
                            } catch (err) {
                                console.error("Lỗi phân tích JSON:", err);
                                fileStatus.textContent = "Lỗi: Tệp JSON không hợp lệ.";
                                fileStatus.classList.add('text-red-600');
                                studentData = [];
                            }
                        };
                        reader.readAsText(file);
                    } else if (file.name.endsWith('.xlsx')) {
                        reader.onload = (event) => {
                            try {
                                const data = event.target.result;
                                const workbook = XLSX.read(data, { type: 'binary' });
                                
                                
                                // Lấy tên tab đầu tiên
                                const sheetName = workbook.SheetNames[0];
                                if (!sheetName) {
                                    alert("Lỗi: File Excel không có tab (sheet) nào.");
                                    fileStatus.textContent = "Lỗi: File Excel rỗng.";
                                    fileStatus.classList.add('text-red-600');
                                    studentData = [];
                                    return;
                                }
                                // Đọc dữ liệu từ tab đầu tiên
                                const worksheet = workbook.Sheets[sheetName];
                                // === KẾT THÚC THAY ĐỔI ===
                                
                                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                                
                                // Phân tích dữ liệu Excel (logic phức tạp)
                                studentData = parseExcelData(jsonData);
                                console.log("Excel Data Parsed:", studentData);
                                alert("Đã tải và phân tích tệp Excel thành công!");
                            } catch (err) {
                                console.error("Lỗi phân tích Excel:", err);
                                fileStatus.textContent = "Lỗi: Không thể đọc tệp Excel.";
                                fileStatus.classList.add('text-red-600');
                                studentData = [];
                            }
                        };
                        reader.readAsBinaryString(file);
                    } else {
                         fileStatus.textContent = "Lỗi: Định dạng tệp không được hỗ trợ.";
                         fileStatus.classList.add('text-red-600');
                         studentData = [];
                    }
                }
            });
            
            function parseExcelData(data) {
                // Đây là một trình phân tích đơn giản, giả sử định dạng 2 (header có thời lượng)
                // data[0] là hàng header, data[1..n] là học sinh
                if (data.length < 2) return [];
                
                const header = data[0];
                const students = data.slice(1);
                const parsedStudents = [];

                // Lấy tên môn và thời lượng từ header
                const subjectsInfo = header.slice(2).map(h => {
                    const match = h.match(/(.*)\((\d+)\)/);
                    if (match) {
                        return { name: match[1].trim(), duration: parseInt(match[2], 10) };
                    }
                    // Thử định dạng 1 (thời lượng trong ô) - phức tạp hơn
                    return null; 
                });

                // Nếu không phân tích được header (Định dạng 1)
                if(subjectsInfo.every(info => info === null)) {
                     // Giả sử định dạng 1: header chỉ là tên môn
                    const subjectNames = header.slice(2);
                    for(const row of students) {
                        if (!row[0] && !row[1]) continue; // Bỏ qua hàng trống
                        const student = {
                            student_id: row[0],
                            name: row[1],
                            subjects: {}
                        };
                        for(let i = 0; i < subjectNames.length; i++) {
                            const duration = parseInt(row[i+2], 10);
                            if (!isNaN(duration) && duration > 0) {
                                student.subjects[subjectNames[i]] = duration;
                            }
                        }
                        parsedStudents.push(student);
                    }
                } else {
                    // Định dạng 2: header có thời lượng
                     for(const row of students) {
                        if (!row[0] && !row[1]) continue; // Bỏ qua hàng trống
                        const student = {
                            student_id: row[0],
                            name: row[1],
                            subjects: {}
                        };
                        for(let i = 0; i < subjectsInfo.length; i++) {
                            if (!subjectsInfo[i]) continue; // Bỏ qua nếu header không hợp lệ
                            // Nếu ô có dấu 'x' hoặc bất kỳ giá trị nào
                            if (row[i+2] !== null && row[i+2] !== undefined && String(row[i+2]).trim() !== "") {
                                student.subjects[subjectsInfo[i].name] = subjectsInfo[i].duration;
                            }
                        }
                        parsedStudents.push(student);
                    }
                }

                return parsedStudents;
            }

            // === 4. LOGIC TẠO LỊCH (MODIFIED: HILL CLIMBING) ===
            const createBtn = document.getElementById('create-schedule-btn');
            const loadingStatus = document.getElementById('loading-status');
            const resultsSection = document.getElementById('ket-qua');
            const form = document.getElementById('schedule-form');

            createBtn.addEventListener('click', () => {
                // Kiểm tra validation
                if (!form.checkValidity()) {
                    form.reportValidity();
                    alert("Vui lòng điền đầy đủ các trường bắt buộc.");
                    return;
                }
                if (studentData.length === 0) {
                    alert("Vui lòng tải lên tệp dữ liệu học sinh hợp lệ.");
                    dataFileInput.focus();
                    return;
                }

                // Thu thập dữ liệu từ form
                const formData = new FormData(form);
                const restDays = Array.from(formData.getAll('rest_days'));
                scheduleConfig = {
                    startDate: formData.get('start_date'),
                    endDate: formData.get('end_date'),
                    restDays: restDays,
                    morningStart: formData.get('start_time_morning'),
                    morningEnd: formData.get('end_time_morning'),
                    afternoonStart: formData.get('start_time_afternoon'),
                    afternoonEnd: formData.get('end_time_afternoon'),
                    breakMinutes: parseInt(formData.get('break_minutes'), 10),
                    numRooms: parseInt(formData.get('num_rooms'), 10),
                    sessionMode: formData.get('session_mode') || 'both',
                    minStudents: parseInt(formData.get('min_students'), 10) || null,
                    maxStudents: parseInt(formData.get('max_students'), 10) || null,
                    roomNames: []
                };

                for (let i = 1; i <= scheduleConfig.numRooms; i++) {
                    const roomName = formData.get(`room_name_${i}`) || `Phòng ${i}`;
                    scheduleConfig.roomNames.push(roomName);
                }

                console.log("Scheduling Config:", scheduleConfig);
                console.log("Student Data:", studentData);
                
                // Hiển thị loading
                loadingStatus.classList.remove('hidden');
                createBtn.disabled = true;

                // Use an async function to allow 'await' for the optimization process
                setTimeout(async () => {
                    try {
                        // Validate dữ liệu đầu vào bằng cách thử tạo một lịch (check thời lượng,...)
                        // Nếu có lỗi, hàm này sẽ throw exception
                        generateMockSchedule(studentData, scheduleConfig);

                        // Bắt đầu tối ưu hóa bằng Hill Climbing với Random Restart
                        console.log("Bắt đầu tối ưu hóa bằng Hill Climbing (Random Restart)...");
                        
                        // Await the async optimization function to complete
                        generatedSchedule = await hillClimbingWithRestart(studentData, scheduleConfig);
                        
                        console.log("Tối ưu hóa hoàn tất.");

                        // Hiển thị kết quả đã được tối ưu
                        displaySchedule(generatedSchedule, studentData);

                        // Ẩn loading và hiển thị kết quả
                        loadingStatus.classList.add('hidden');
                        createBtn.disabled = false;
                        resultsSection.classList.remove('hidden');
                        
                        // Cuộn đến phần kết quả
                        resultsSection.scrollIntoView({ behavior: 'smooth' });
                    } catch (e) {
                        // Bắt lỗi (ví dụ: lỗi thời lượng không đồng nhất)
                        console.error("Lỗi khi tạo lịch:", e);
                        alert(e.message); // Hiển thị lỗi cho người dùng
                        loadingStatus.classList.add('hidden');
                        createBtn.disabled = false;
                    }
                }, 500); // Giảm delay để bắt đầu nhanh hơn
            });
            
            function generateMockSchedule(students, config) {
                // 1. Thu thập tất cả các môn thi, thời lượng, và DS học sinh
                const allSubjects = {};
                students.forEach(student => {
                    Object.keys(student.subjects).forEach(subjectName => {
                        if (!allSubjects[subjectName]) {
                            allSubjects[subjectName] = {
                                duration: student.subjects[subjectName],
                                students: new Set()
                            };
                        }
                        allSubjects[subjectName].students.add(student.student_id);
                    });
                });

                // KIỂM TRA RÀNG BUỘC THỜI LƯỢNG ĐỒNG NHẤT
                const durationErrors = new Set();
                students.forEach(student => {
                    Object.keys(student.subjects).forEach(subjectName => {
                        if (allSubjects[subjectName] && allSubjects[subjectName].duration !== student.subjects[subjectName]) {
                            durationErrors.add(subjectName);
                        }
                    });
                });
                
                if (durationErrors.size > 0) {
                    throw new Error(`Lỗi Dữ Liệu: Thời lượng không đồng nhất cho các môn: ${Array.from(durationErrors).join(', ')}. Vui lòng kiểm tra lại file đầu vào.`);
                }

                // 2. Chuẩn bị danh sách môn học để xếp lịch
                const subjectList = Object.keys(allSubjects).map(name => ({
                    name: name,
                    duration: allSubjects[name].duration,
                    studentIds: Array.from(allSubjects[name].students)
                }));

                // XÁO TRỘN danh sách môn học để tạo lịch ngẫu nhiên
                // Đây là cốt lõi của RANDOM RESTART - mỗi lần gọi hàm này sẽ ra một thứ tự xếp khác nhau
                for (let i = subjectList.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [subjectList[i], subjectList[j]] = [subjectList[j], subjectList[i]];
                }

                const aggregatedSchedule = [];
                const studentSchedules = {}; // student_id -> array of { startTime, endTime, date }
                students.forEach(s => studentSchedules[s.student_id] = []);

                // NOTE: dateLoad will be initialized after dates[] is built below

                // 3. Chuẩn bị dòng thời gian cho mỗi phòng thi
                const roomAvailability = {};
                const dates = [];
                
                // FIX: Manually parse date strings to avoid timezone issues, treating them as local dates.
                const startParts = config.startDate.split('-');
                const d_start = new Date(startParts[0], startParts[1] - 1, startParts[2]);
                
                const endParts = config.endDate.split('-');
                const d_end = new Date(endParts[0], endParts[1] - 1, endParts[2]);

                for (let d = new Date(d_start); d <= d_end; d.setDate(d.getDate() + 1)) {
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    const dateString = `${year}-${month}-${day}`;

                    // Exclude rest days
                    if (!config.restDays.includes(dateString)) {
                        dates.push(dateString);
                    }
                }

                if (dates.length === 0) {
                    throw new Error("Không có ngày thi nào hợp lệ. Vui lòng kiểm tra lại ngày bắt đầu, kết thúc và các ngày nghỉ đã chọn.");
                }

                // Track load per date (số lượng học sinh đã xếp cho ngày đó) để cân bằng ngày
                const dateLoad = {};
                dates.forEach(d => dateLoad[d] = 0);

                // Xác định các session khả dụng dựa trên config.sessionMode
                const sessions = (config.sessionMode === 'morning') ? ['Sáng'] : (config.sessionMode === 'afternoon') ? ['Chiều'] : ['Sáng', 'Chiều'];

                config.roomNames.forEach(room => {
                    roomAvailability[room] = {};
                    dates.forEach(date => {
                        roomAvailability[room][date] = {};
                        sessions.forEach(session => {
                            roomAvailability[room][date][session] = (session === 'Sáng') ? config.morningStart : config.afternoonStart;
                        });
                    });
                });

                // 4. Lặp qua các môn học đã xáo trộn và xếp vào lịch
                function splitIntoGroups(arr, groups) {
                    const n = arr.length;
                    const result = Array.from({ length: groups }, () => []);
                    if (groups <= 0) return result;
                    const base = Math.floor(n / groups);
                    let rem = n % groups;
                    let idx = 0;
                    for (let i = 0; i < groups; i++) {
                        const size = base + (rem > 0 ? 1 : 0);
                        if (rem > 0) rem--;
                        result[i] = arr.slice(idx, idx + size);
                        idx += size;
                    }
                    return result;
                }

                for (const subject of subjectList) {
                    let placed = false;
                    // Lặp qua các ngày theo thứ tự tải (ít trước) để cân bằng ngày
                    const datesByLoad = dates.slice().sort((a, b) => dateLoad[a] - dateLoad[b]);
                    for (const date of datesByLoad) {
                        for (const session of sessions) {
                            // Tìm các phòng khả dụng cho session này (vẫn còn thời gian để xếp môn)
                            const sessionEndTimeStr = (session === 'Sáng') ? config.morningEnd : config.afternoonEnd;
                            const availableRooms = [];
                            for (const room of config.roomNames) {
                                const nextAvailableTimeStr = roomAvailability[room][date][session];
                                const [h, m] = nextAvailableTimeStr.split(':').map(Number);
                                const startTime = new Date(`${date}T00:00:00`);
                                startTime.setHours(h, m);
                                const endTime = new Date(startTime.getTime() + subject.duration * 60000);
                                const sessionEndTime = new Date(`${date}T${sessionEndTimeStr}`);
                                if (endTime <= sessionEndTime) {
                                    availableRooms.push({ room, nextAvailableTimeStr, startTime, endTime });
                                }
                            }

                            if (availableRooms.length === 0) continue;


                            const nStudents = subject.studentIds.length;
                            const maxRoomsForSubject = availableRooms.length;
                            let groups = [];
                            let targetRooms = 0;

                            // Logic to determine number of groups based on constraints
                            if (config.minStudents > 0 && config.maxStudents > 0 && config.minStudents <= config.maxStudents) {
                                const min = config.minStudents;
                                const max = config.maxStudents;

                                // Calculate the valid range for the number of rooms (r)
                                const minR = Math.ceil(nStudents / max);
                                const maxR = Math.floor(nStudents / min);

                                let bestR = -1;

                                // Find the largest valid 'r' that fits within our available rooms to maximize splitting.
                                for (let r = Math.min(maxR, maxRoomsForSubject); r >= minR; r--) {
                                    if (r > 0) {
                                        bestR = r;
                                        break;
                                    }
                                }

                                if (bestR !== -1) {
                                    targetRooms = bestR;
                                    groups = splitIntoGroups(subject.studentIds, targetRooms);
                                } else {
                                    // No valid 'r' found, so we can't schedule this subject in this slot.
                                    continue; // Try next session
                                }
                            } else {
                                // No constraints or invalid constraints, so split as evenly as possible among available rooms.
                                targetRooms = maxRoomsForSubject;
                                groups = splitIntoGroups(subject.studentIds, targetRooms);
                            }

                            // Kiểm tra xung đột cho toàn bộ nhóm trước khi ghi lịch
                            let anyConflict = false;
                            for (let gi = 0; gi < groups.length; gi++) {
                                const grp = groups[gi];
                                if (grp.length === 0) continue;
                                const avail = availableRooms[gi];
                                const startTime = avail.startTime;
                                const endTime = new Date(startTime.getTime() + subject.duration * 60000);

                                for (const studentId of grp) {
                                    for (const scheduledExam of studentSchedules[studentId]) {
                                        if (scheduledExam.date === date) {
                                            const existingStart = new Date(`${date}T${scheduledExam.startTime}`);
                                            const existingEnd = new Date(`${date}T${scheduledExam.endTime}`);
                                            if (startTime < existingEnd && endTime > existingStart) {
                                                anyConflict = true;
                                                break;
                                            }
                                        }
                                    }
                                    if (anyConflict) break;
                                }
                                if (anyConflict) break;
                            }

                            if (anyConflict) continue; // thử session/phòng khác

                            // Ghi lịch cho từng nhóm vào từng phòng tương ứng
                            for (let gi = 0; gi < groups.length; gi++) {
                                const grp = groups[gi];
                                if (grp.length === 0) continue;
                                const avail = availableRooms[gi];
                                const room = avail.room;
                                const startStr = avail.nextAvailableTimeStr;
                                const startTime = avail.startTime;
                                const endTime = new Date(startTime.getTime() + subject.duration * 60000);
                                const endStr = endTime.toTimeString().slice(0, 5);

                                aggregatedSchedule.push({
                                    date: date,
                                    session: session,
                                    startTime: startStr,
                                    endTime: endStr,
                                    room: room,
                                    subject: subject.name,
                                    duration: subject.duration,
                                    studentIds: grp
                                });

                                grp.forEach(studentId => {
                                    studentSchedules[studentId].push({
                                        date: date,
                                        startTime: startStr,
                                        endTime: endStr
                                    });
                                });

                                // Cập nhật thời gian sẵn sàng tiếp theo của phòng
                                const nextStartTime = new Date(endTime.getTime() + config.breakMinutes * 60000);
                                roomAvailability[room][date][session] = nextStartTime.toTimeString().slice(0, 5);
                                // Cập nhật tải cho ngày này
                                dateLoad[date] = (dateLoad[date] || 0) + grp.length;
                            }

                            placed = true;
                            break;
                        }
                        if (placed) break;
                    }
                    if (!placed) {
                        console.warn(`Không thể xếp lịch cho môn: ${subject.name}`);
                    }
                }
                
                return aggregatedSchedule;
            }

            // Hàm này bây giờ CHỈ tạo dữ liệu, renderTable sẽ hiển thị
            function displaySchedule(aggregatedSchedule, students) {
                const tableContainer = document.getElementById('schedule-table-container');
                const placeholder = document.getElementById('schedule-placeholder');
                const paginationControls = document.getElementById('pagination-controls');

                if (!aggregatedSchedule || aggregatedSchedule.length === 0) {
                    placeholder.textContent = 'Không tạo được lịch thi.';
                    placeholder.classList.remove('hidden');
                    tableContainer.classList.add('hidden');
                    paginationControls.classList.add('hidden');
                    return;
                }

                // 1. Tạo lịch chi tiết từ lịch tổng hợp (sử dụng helper)
                detailedScheduleData = getDetailedSchedule(aggregatedSchedule, students);

                // 2. Reset phân trang và sắp xếp
                currentPage = 1;
                sortConfig = { key: 'studentName', direction: 'asc' };

                // 3. Hiển thị table và pagination, ẩn placeholder
                placeholder.classList.add('hidden');
                tableContainer.classList.remove('hidden');
                paginationControls.classList.remove('hidden');

                // 4. Render bảng
                renderTable();
            }
            
            // HÀM MỚI: RenderTable (Xử lý sắp xếp, phân trang và vẽ bảng)
            function renderTable() {
                const table = document.getElementById('schedule-table');
                const thead = table.querySelector('thead');
                const tbody = table.querySelector('tbody');
                
                const paginationControls = document.getElementById('pagination-controls');
                const pageInfo = document.getElementById('page-info');
                const prevPageBtn = document.getElementById('prev-page-btn');
                const nextPageBtn = document.getElementById('next-page-btn');

                // 1. Sắp xếp dữ liệu
                detailedScheduleData.sort((a, b) => {
                    let valA = a[sortConfig.key];
                    let valB = b[sortConfig.key];
                    
                    if (valA < valB) {
                        return sortConfig.direction === 'asc' ? -1 : 1;
                    }
                    if (valA > valB) {
                        return sortConfig.direction === 'asc' ? 1 : -1;
                    }
                    return 0;
                });

                // 2. Phân trang dữ liệu
                const startIndex = (currentPage - 1) * rowsPerPage;
                const endIndex = startIndex + rowsPerPage;
                const paginatedItems = detailedScheduleData.slice(startIndex, endIndex);
                const totalPages = Math.ceil(detailedScheduleData.length / rowsPerPage);

                // 3. Xóa và vẽ lại Header (để thêm chỉ báo sắp xếp)
                thead.innerHTML = '';
                const headerRow = document.createElement('tr');
                const headers = [
                    { key: 'studentName', text: 'Học sinh' },
                    { key: 'studentId', text: 'Mã SV' },
                    { key: 'subject', text: 'Môn thi' },
                    { key: 'duration', text: 'Thời lượng (phút)' },
                    { key: 'date', text: 'Ngày thi' },
                    { key: 'session', text: 'Ca thi' },
                    { key: 'startTime', text: 'Giờ bắt đầu' },
                    { key: 'endTime', text: 'Giờ kết thúc' },
                    { key: 'room', text: 'Phòng thi' }
                ];

                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.scope = 'col';
                    th.className = 'px-6 py-3';
                    th.textContent = header.text;
                    th.dataset.sortKey = header.key; // Quan trọng cho việc click

                    if (sortConfig.key === header.key) {
                        th.textContent += sortConfig.direction === 'asc' ? ' ↑' : ' ↓';
                    }
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);

                // 4. Xóa và vẽ lại Body
                tbody.innerHTML = '';
                if (paginatedItems.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center p-4">Không có dữ liệu.</td></tr>`;
                } else {
                    paginatedItems.forEach(entry => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white border-b hover:bg-pink-50';
                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${entry.studentName}</td>
                            <td class="px-6 py-4">${entry.studentId}</td>
                            <td class="px-6 py-4 font-semibold text-pink-700">${entry.subject}</td>
                            <td class="px-6 py-4">${entry.duration}</td>
                            <td class="px-6 py-4">${entry.date}</td>
                            <td class="px-6 py-4">${entry.session}</td>
                            <td class="px-6 py-4">${entry.startTime}</td>
                            <td class="px-6 py-4">${entry.endTime}</td>
                            <td class="px-6 py-4">${entry.room}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                // 5. Cập nhật điều khiển phân trang
                pageInfo.textContent = `Trang ${currentPage} / ${totalPages}`;
                prevPageBtn.disabled = (currentPage === 1);
                nextPageBtn.disabled = (currentPage === totalPages);
            }

            // === 5. LOGIC TẠO LẠI LỊCH ===
            document.getElementById('regenerate-schedule-btn').addEventListener('click', () => {
                if (!scheduleConfig.startDate) {
                    alert("Vui lòng tạo lịch lần đầu trước khi tạo lại.");
                    return;
                }

                const regenBtn = document.getElementById('regenerate-schedule-btn');
                regenBtn.disabled = true;
                loadingStatus.classList.remove('hidden');
                createBtn.disabled = true;

                setTimeout(async () => {
                    try {
                        // Tối ưu hóa lại bằng thuật toán Hill Climbing
                        console.log("Bắt đầu tái tối ưu hóa bằng Hill Climbing...");
                        generatedSchedule = await hillClimbingWithRestart(studentData, scheduleConfig);
                        console.log("Tái tối ưu hóa hoàn tất.");

                        displaySchedule(generatedSchedule, studentData);
                    } catch (e) {
                        console.error("Lỗi khi tạo lại lịch:", e);
                        alert(e.message || "Đã xảy ra lỗi khi tạo lại lịch.");
                    } finally {
                        loadingStatus.classList.add('hidden');
                        createBtn.disabled = false;
                        regenBtn.disabled = false;
                    }
                }, 300);
            });

            // --- THAY THẾ THUẬT TOÁN SA BẰNG HILL CLIMBING VỚI RANDOM RESTART ---
            async function hillClimbingWithRestart(students, config) {
                const MAX_RESTARTS = 10; // Số lần thử khởi động lại để tránh kẹt cực trị địa phương
                const MAX_ITERATIONS_PER_RUN = 5000; // Số bước leo đồi mỗi lần
                
                let globalBestSchedule = null;
                let globalBestCost = Infinity;

                console.log(`Bắt đầu thuật toán Hill Climbing (kèm Random Restart x${MAX_RESTARTS})...`);

                for (let restart = 0; restart < MAX_RESTARTS; restart++) {
                    // 1. Tạo trạng thái ban đầu ngẫu nhiên (Random Restart)
                    // Hàm generateMockSchedule đã có logic xáo trộn môn học ngẫu nhiên mỗi khi gọi
                    let currentSchedule = null;
                    try {
                        currentSchedule = generateMockSchedule(students, config);
                    } catch (e) {
                        console.warn("Lỗi khi sinh lịch ngẫu nhiên trong vòng lặp:", e);
                        continue;
                    }
                    
                    let currentCost = calculateCost(currentSchedule, students, config);

                    // Nếu đây là lần đầu tiên, gán luôn làm global best để có dữ liệu
                    if (globalBestSchedule === null) {
                        globalBestSchedule = JSON.parse(JSON.stringify(currentSchedule));
                        globalBestCost = currentCost;
                    }

                    // 2. Hill Climbing (Stochastic / First-Choice Variant để tăng tốc)
                    for (let i = 0; i < MAX_ITERATIONS_PER_RUN; i++) {
                        // Tạo một tập các hàng xóm và chọn cái tốt nhất (Steepest Ascent cục bộ)
                        const SAMPLE_SIZE = 10;
                        let bestNeighborInSample = null;
                        let bestNeighborCost = Infinity;

                        for(let n=0; n < SAMPLE_SIZE; n++) {
                            const neighbor = getNeighbor(currentSchedule);
                            const neighborCost = calculateCost(neighbor, students, config);
                            if (neighborCost < bestNeighborCost) {
                                bestNeighborInSample = neighbor;
                                bestNeighborCost = neighborCost;
                            }
                        }

                        // So sánh với hiện tại
                        if (bestNeighborInSample && bestNeighborCost < currentCost) {
                            // Tìm thấy trạng thái tốt hơn -> Leo lên (Di chuyển)
                            currentSchedule = bestNeighborInSample;
                            currentCost = bestNeighborCost;
                        } else {
                            // Không tìm thấy hàng xóm tốt hơn trong mẫu thử
                            // Trong HC thuần túy, đây là Local Optima -> Dừng vòng lặp leo đồi này
                            // Tuy nhiên để chắc chắn, ta có thể thử thêm vài vòng hoặc chấp nhận dừng luôn
                            // Ở đây ta chọn dừng sớm (break) để chuyển sang lần Restart tiếp theo
                            break; 
                        }

                        // Nhường luồng cho UI cập nhật mỗi 100 bước
                        if (i % 100 === 0) await new Promise(r => setTimeout(r, 0));
                    }

                    console.log(`Restart ${restart + 1}: Cost = ${currentCost}`);

                    // 3. Cập nhật kết quả tốt nhất toàn cục
                    if (currentCost < globalBestCost) {
                        globalBestCost = currentCost;
                        globalBestSchedule = JSON.parse(JSON.stringify(currentSchedule));
                        console.log(`-> Tìm thấy kỷ lục mới: ${globalBestCost}`);
                    }

                    // Nếu đạt điểm tuyệt đối, dừng toàn bộ thuật toán
                    if (globalBestCost === 0) break;
                }

                console.log(`Kết thúc thuật toán. Chi phí tối ưu nhất: ${globalBestCost}`);
                return globalBestSchedule;
            }

            // Hàm tính chi phí (Cost Function) - Giữ nguyên logic đánh giá
            function calculateCost(schedule, students, config) {
                let cost = 0;
                const MAX_EXAMS_PER_DAY = 2; // Ràng buộc mềm: Tối đa 2 môn/ngày cho 1 SV

                // 1. Chi phí Ràng buộc Phòng (Min/Max/Exact) và Cân bằng phòng
                const roomOccupancy = {}; // Map<roomName, numStudents[]>
                
                schedule.forEach(entry => {
                    const numStudents = entry.studentIds.length;
                    if (config.minStudents && numStudents < config.minStudents) cost += 500; // Vi phạm cứng
                    if (config.maxStudents && numStudents > config.maxStudents) cost += 1000; // Vi phạm cứng

                    if (!roomOccupancy[entry.room]) roomOccupancy[entry.room] = [];
                    roomOccupancy[entry.room].push(numStudents);
                });

                const allOccupancies = Object.values(roomOccupancy).flat();
                if (allOccupancies.length > 1) {
                    const mean = allOccupancies.reduce((a, b) => a + b, 0) / allOccupancies.length;
                    const variance = allOccupancies.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / allOccupancies.length;
                    cost += Math.sqrt(variance); // Chi phí mềm
                }

                // 2. Chi phí Xung đột học sinh, Mật độ thi, và Khoảng trống
                const detailed = getDetailedSchedule(schedule, students);
                const studentTimeMap = new Map(); 

                for (const entry of detailed) {
                    const studentId = entry.studentId;
                    const date = entry.date;
                    const timeKey = `${date}_${entry.startTime}`;
                    
                    if (!studentTimeMap.has(studentId)) {
                        studentTimeMap.set(studentId, { schedule: new Map(), examsPerDay: new Map() });
                    }
                    
                    const studentInfo = studentTimeMap.get(studentId);

                    // Kiểm tra xung đột lịch (vi phạm cứng)
                    const scheduleCount = (studentInfo.schedule.get(timeKey) || 0) + 1;
                    studentInfo.schedule.set(timeKey, scheduleCount);
                    if (scheduleCount > 1) cost += 1000;

                    // Cập nhật số môn thi/ngày
                    const examsToday = (studentInfo.examsPerDay.get(date) || 0) + 1;
                    studentInfo.examsPerDay.set(date, examsToday);
                }

                // Tính chi phí cho mật độ thi và khoảng trống
                studentTimeMap.forEach((studentInfo, studentId) => {
                    const dailySchedules = {}; // Group exams by date
                    studentInfo.schedule.forEach((count, timeKey) => {
                        const [date, time] = timeKey.split('_');
                        if (!dailySchedules[date]) dailySchedules[date] = [];
                        dailySchedules[date].push(time);
                    });

                    Object.keys(dailySchedules).forEach(date => {
                        const examsToday = dailySchedules[date];
                        // Phạt mật độ thi
                        if (examsToday.length > MAX_EXAMS_PER_DAY) {
                            cost += 10 * Math.pow(2, examsToday.length - MAX_EXAMS_PER_DAY); // Vi phạm mềm
                        }

                        // Phạt khoảng trống (nếu có nhiều hơn 1 môn trong ngày)
                        if (examsToday.length > 1) {
                            const timesInMinutes = examsToday.map(t => {
                                const [h, m] = t.split(':').map(Number);
                                return h * 60 + m;
                            }).sort((a, b) => a - b);
                            
                            const firstExamEnd = timesInMinutes[0] + 90; // Giả sử trung bình 90 phút
                            const lastExamStart = timesInMinutes[timesInMinutes.length - 1];
                            const gap = lastExamStart - firstExamEnd;

                            if (gap > 120) { // Phạt nếu khoảng trống > 2 giờ
                                cost += (gap / 60) * 0.5; // Phạt 0.5 điểm cho mỗi giờ trống
                            }
                        }
                    });
                });

                return cost;
            }

            // Hàm lấy "hàng xóm" (Neighbor Function) - Hoán đổi nội dung của kíp thi
            function getNeighbor(schedule) {
                let newSchedule = JSON.parse(JSON.stringify(schedule));
                if (newSchedule.length < 2) return newSchedule;

                const idx1 = Math.floor(Math.random() * newSchedule.length);
                let idx2 = Math.floor(Math.random() * newSchedule.length);
                while(idx1 === idx2) {
                    idx2 = Math.floor(Math.random() * newSchedule.length);
                }

                // Hoán đổi NỘI DUNG (subject, students, duration) giữa 2 slot
                const tempContent = {
                    subject: newSchedule[idx1].subject,
                    duration: newSchedule[idx1].duration,
                    studentIds: newSchedule[idx1].studentIds,
                };
                
                newSchedule[idx1].subject = newSchedule[idx2].subject;
                newSchedule[idx1].duration = newSchedule[idx2].duration;
                newSchedule[idx1].studentIds = newSchedule[idx2].studentIds;
                
                newSchedule[idx2].subject = tempContent.subject;
                newSchedule[idx2].duration = tempContent.duration;
                newSchedule[idx2].studentIds = tempContent.studentIds;

                // Cập nhật lại giờ kết thúc cho cả 2 slot đã bị thay đổi
                [idx1, idx2].forEach(idx => {
                    const entry = newSchedule[idx];
                    const [h, m] = entry.startTime.split(':').map(Number);
                    const startTime = new Date(`${entry.date}T00:00:00`);
                    startTime.setHours(h, m);
                    const endTime = new Date(startTime.getTime() + entry.duration * 60000);
                    entry.endTime = endTime.toTimeString().slice(0, 5);
                });

                return newSchedule;
            }

            // Helper function to expand schedule
            function getDetailedSchedule(aggregatedSchedule, students) {
                const studentMap = new Map();
                students.forEach(s => {
                    studentMap.set(s.student_id, s.name);
                });

                const detailedSchedule = [];
                aggregatedSchedule.forEach(entry => {
                    entry.studentIds.forEach(studentId => {
                        detailedSchedule.push({
                            studentId: studentId,
                            studentName: studentMap.get(studentId) || "N/A",
                            subject: entry.subject,
                            duration: entry.duration,
                            date: entry.date,
                            session: entry.session,
                            startTime: entry.startTime,
                            endTime: entry.endTime,
                            room: entry.room,
                            notes: ""
                        });
                    });
                });
                
                // Sắp xếp
                detailedSchedule.sort((a, b) => {
                    if (a.date < b.date) return -1;
                    if (a.date > b.date) return 1;
                    if (a.startTime < b.startTime) return -1;
                    if (a.startTime > b.startTime) return 1;
                    if (a.studentName < b.studentName) return -1;
                    if (a.studentName > b.studentName) return 1;
                    return 0;
                });
                
                return detailedSchedule;
            }

            // === 6. LOGIC XUẤT FILE ===
            document.getElementById('export-pdf-btn').addEventListener('click', () => {
                console.log('Bắt đầu quá trình xuất PDF...');
                if (generatedSchedule.length === 0) {
                    alert("Chưa có lịch thi để xuất.");
                    return;
                }

                const detailedSchedule = getDetailedSchedule(generatedSchedule, studentData);
                if (detailedSchedule.length === 0) {
                    alert("Không có dữ liệu chi tiết để xuất.");
                    return;
                }
                
                // Kiểm tra thư viện
                if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                    alert('Lỗi: Thư viện jsPDF chưa được tải. Không thể xuất PDF.');
                    console.error('jsPDF library not loaded.');
                    return;
                }
                if (typeof window.jspdf.jsPDF.API.autoTable !== 'function') {
                    alert('Lỗi: Thư viện jsPDF-AutoTable chưa được tải. Không thể xuất PDF.');
                    console.error('jsPDF-AutoTable plugin not loaded.');
                    return;
                }

                const exportBtn = document.getElementById('export-pdf-btn');
                exportBtn.disabled = true;
                exportBtn.textContent = 'Đang xuất PDF...';

                // Hàm xóa dấu tiếng Việt
                function removeAccents(str) {
                    if (!str) return '';
                    return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/đ/g, 'd').replace(/Đ/g, 'D');
                }

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

                    // Chuẩn bị dữ liệu cho autoTable (không dấu)
                    const head = [[
                        'Hoc sinh', 'Ma SV', 'Mon thi', 'Thoi luong (phut)', 'Ngay thi', 'Ca thi', 'Gio bat dau', 'Gio ket thuc', 'Phong thi'
                    ]];
                    const body = detailedSchedule.map(entry => [
                        removeAccents(entry.studentName),
                        entry.studentId, // Mã SV thường không có dấu
                        removeAccents(entry.subject),
                        entry.duration,
                        entry.date,
                        removeAccents(entry.session),
                        entry.startTime,
                        entry.endTime,
                        removeAccents(entry.room)
                    ]);

                    // Thêm tiêu đề (không dấu)
                    doc.setFontSize(22);
                    doc.text(removeAccents('LỊCH THI CHI TIẾT'), doc.internal.pageSize.getWidth() / 2, 40, { align: 'center' });
                    
                    doc.setFontSize(14);
                    doc.text(removeAccents(`Ngày thi từ ${scheduleConfig.startDate} đến ${scheduleConfig.endDate}`), doc.internal.pageSize.getWidth() / 2, 60, { align: 'center' });

                    // Tạo bảng
                    doc.autoTable({
                        head: head,
                        body: body,
                        startY: 80,
                        styles: {
                            // font: 'Roboto-Regular', // Bỏ font tùy chỉnh, dùng font mặc định
                            fontSize: 8,
                            cellPadding: 2,
                        },
                        headStyles: {
                            fillColor: [242, 242, 242],
                            textColor: [50, 50, 50],
                            fontStyle: 'bold',
                        },
                        didDrawPage: function (data) {
                            // Có thể thêm header/footer cho mỗi trang nếu muốn
                        }
                    });

                    console.log('Bắt đầu lưu file PDF...');
                    doc.save('LichThi_ChiTiet.pdf');
                    console.log('File PDF đã được lưu.');

                } catch (e) {
                    console.error("Lỗi chung khi xuất PDF: ", e);
                    alert("Đã xảy ra lỗi khi xuất PDF. Kiểm tra console để biết chi tiết.");
                } finally {
                    exportBtn.disabled = false;
                    exportBtn.textContent = 'Xuất File PDF';
                }
            });

            // === 7. LOGIC TẢI FILE MẪU ===
            document.getElementById('download-template-btn').addEventListener('click', () => {
                try {
                    // Dữ liệu cho sheet Hướng Dẫn
                    const instructionsData = [
                        ["HƯỚNG DẪN SỬ DỤNG FILE MẪU"],
                        [],
                        // === THAY ĐỔI: Cập nhật hướng dẫn ===
                        ["QUAN TRỌNG:", "Hệ thống sẽ tự động đọc tab (sheet) ĐẦU TIÊN trong file Excel của bạn."],
                        [],
                        // === KẾT THÚC THAY ĐỔI ===
                        ["ĐỊNH DẠNG 1: Header là Tên Môn, Ô chứa Thời Lượng"],
                        ["Ví dụ:", "Nếu dùng định dạng này, hãy xóa các cột mẫu (Toán(60), Lý(90),...) và thay bằng tên môn (Toán, Lý,...)."],
                        ["student_id", "name", "Toán", "Lý", "Hóa"],
                        [1, "SV001", 60, 90, ""],
                        [2, "SV002", 60, "", 120],
                        [],
                        ["ĐỊNH DẠNG 2 (Khuyên dùng): Header Tên Môn (Thời Lượng)"],
                        ["Ví dụ:", "Điền '✓' hoặc 'x' vào ô nếu học sinh thi môn đó. Thời lượng được lấy từ header."],
                        ["student_id", "name", "Toán(60)", "Lý(90)", "Hóa(60)"],
                        [1, "SV001", "✓", "✓", ""],
                        [2, "SV002", "", "✓", "✓"],
                        [3, "SV003", "✓", "", "✓"],
                        [],
                        ["LƯU Ý:", "Thời lượng của cùng một môn phải giống nhau. Ví dụ: Nếu có 2 cột 'Toán(60)' và 'Toán(90)', hệ thống sẽ báo lỗi."]
                    ];
                    const wsInstructions = XLSX.utils.aoa_to_sheet(instructionsData);
                    wsInstructions['!cols'] = [{ wch: 15 }, { wch: 80 }]; // Set column width

                    // Dữ liệu mẫu cho sheet 'DuLieuHocSinh' (Định dạng 2)
                    const wsData = [
                        ["student_id", "name", "Toán(60)", "Lý(90)", "Hóa(60)"],
                        [1, "SV001", "✓", "✓", ""],
                        [2, "SV002", "", "✓", "✓"],
                        [3, "SV003", "✓", "", "✓"],
                        [4, "SV004", "✓", "✓", "✓"],
                        [5, "SV005", "✓", "", ""],
                    ];
                    const wsDataSheet = XLSX.utils.aoa_to_sheet(wsData);
                    wsDataSheet['!cols'] = [{ wch: 10 }, { wch: 15 }, { wch: 10 }, { wch: 10 }, { wch: 10 }];

                    // Tạo workbook
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, wsInstructions, 'HuongDan');
                    XLSX.utils.book_append_sheet(wb, wsDataSheet, 'DuLieuHocSinh');
                    
                    // Đảm bảo 'HuongDan' là tab đầu tiên
                    wb.SheetNames = ['HuongDan', 'DuLieuHocSinh'];

                    // Xuất file
                    XLSX.writeFile(wb, 'Mau_Du_Lieu_Hoc_Sinh.xlsx');
                } catch(e) {
                    console.error("Lỗi tạo file mẫu: ", e);
                    alert("Đã xảy ra lỗi khi tạo file mẫu Excel.");
                }
            });

            // ===== Export Excel for generated schedule =====
            document.getElementById('export-excel-btn').addEventListener('click', () => {
                if (generatedSchedule.length === 0) {
                    alert('Chưa có lịch thi để xuất.');
                    return;
                }

                try {
                    const detailed = getDetailedSchedule(generatedSchedule, studentData);
                    if (!detailed || detailed.length === 0) {
                        alert('Không có dữ liệu chi tiết để xuất.');
                        return;
                    }

                    // Tạo header và body
                    const aoa = [];
                    aoa.push(['Học sinh', 'Mã SV', 'Môn thi', 'Thời lượng (phút)', 'Ngày thi', 'Ca thi', 'Giờ bắt đầu', 'Giờ kết thúc', 'Phòng thi']);
                    detailed.forEach(r => {
                        aoa.push([r.studentName, r.studentId, r.subject, r.duration, r.date, r.session, r.startTime, r.endTime, r.room]);
                    });

                    const ws = XLSX.utils.aoa_to_sheet(aoa);
                    // Tùy chỉnh độ rộng cột cơ bản
                    ws['!cols'] = [{ wch: 25 }, { wch: 12 }, { wch: 18 }, { wch: 10 }, { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 12 }];

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'LichThi_ChiTiet');
                    XLSX.writeFile(wb, 'LichThi_ChiTiet.xlsx');
                } catch (e) {
                    console.error('Lỗi xuất Excel:', e);
                    alert('Đã xảy ra lỗi khi xuất Excel. Kiểm tra console để biết chi tiết.');
                }
            });

            // === 8. LOGIC PHÂN TRANG VÀ SẮP XẾP (EVENT LISTENERS) ===
            // Sắp xếp
            document.getElementById('schedule-table').querySelector('thead').addEventListener('click', (e) => {
                const th = e.target.closest('th'); // Lấy thẻ TH
                if (!th) return;

                const key = th.dataset.sortKey;
                if (!key) return;

                // Cập nhật cấu hình sắp xếp
                if (sortConfig.key === key) {
                    sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortConfig.key = key;
                    sortConfig.direction = 'asc';
                }
                
                // Render lại trang hiện tại với sắp xếp mới
                renderTable();
            });

            // Phân trang
            document.getElementById('prev-page-btn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            });

            document.getElementById('next-page-btn').addEventListener('click', () => {
                const totalPages = Math.ceil(detailedScheduleData.length / rowsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                }
            });

        });
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>